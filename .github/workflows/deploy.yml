name: Deploy to Production

on:
  # Trigger after successful build
  workflow_run:
    workflows: ["Build and Push Image"]
    types:
      - completed
    branches: [main]
  # Allow manual deployment with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.2.1 or latest)'
        required: true
        default: 'latest'

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Install Scaleway CLI
        run: |
          curl -s https://raw.githubusercontent.com/scaleway/scaleway-cli/master/scripts/get.sh | sh
          scw version
      
      - name: Deploy to Scaleway Serverless Container
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_ORGANIZATION_ID }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_PROJECT_ID }}
          SCW_DEFAULT_REGION: fr-par
        run: |
          # Determine version to deploy
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="latest"
          fi
          
          echo "Deploying version: ${VERSION}"
          
          # Update container to use the new image
          scw container container update ${{ secrets.SCW_CONTAINER_ID }} \
            registry-image=rg.fr-par.scw.cloud/ns-solagratia-prd/solagratia-fr:${VERSION} \
            redeploy=true
          
          echo "Deployment completed successfully!"
